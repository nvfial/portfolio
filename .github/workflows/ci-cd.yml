name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}/portfolio-backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/portfolio-frontend
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # 代码质量检查
  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: my-portfolio/package-lock.json

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          cache-dependency-path: my-portfolio-backend/pom.xml

      - name: 前端依赖安装
        working-directory: ./my-portfolio
        run: npm ci

      - name: 前端代码检查
        working-directory: ./my-portfolio
        run: |
          npm run lint || echo "Lint检查未配置，跳过"

      - name: 后端代码检查
        working-directory: ./my-portfolio-backend
        run: |
          mvn checkstyle:check || echo "Checkstyle未配置，跳过"
          mvn spotbugs:check || echo "SpotBugs未配置，跳过"

  # 前端构建和测试
  frontend-build:
    name: 前端构建测试
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: my-portfolio/package-lock.json

      - name: 安装依赖
        working-directory: ./my-portfolio
        run: npm ci

      - name: 运行前端测试
        working-directory: ./my-portfolio
        run: |
          npm test || echo "测试未配置，跳过"
        continue-on-error: true

      - name: 构建前端
        working-directory: ./my-portfolio
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:8080' }}

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: my-portfolio/dist
          retention-days: 7

  # 后端构建和测试
  backend-build:
    name: 后端构建测试
    runs-on: ubuntu-latest
    needs: code-quality
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: portfolio_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          cache-dependency-path: my-portfolio-backend/pom.xml

      - name: 运行后端测试
        working-directory: ./my-portfolio-backend
        run: mvn test
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/portfolio_test
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root
          SPRING_REDIS_HOST: localhost
          SPRING_REDIS_PORT: 6379

      - name: 生成测试报告
        working-directory: ./my-portfolio-backend
        run: |
          mvn surefire-report:report || echo "测试报告生成失败"
        continue-on-error: true

      - name: 上传测试报告
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-report
          path: my-portfolio-backend/target/surefire-reports
          retention-days: 30

      - name: 构建后端
        working-directory: ./my-portfolio-backend
        run: mvn clean package -DskipTests

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: my-portfolio-backend/target/*.jar
          retention-days: 7

  # 安全扫描
  security-scan:
    name: 安全扫描
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 前端依赖安全扫描
        uses: snyk/actions/node@master
        working-directory: ./my-portfolio
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: 后端依赖安全扫描
        working-directory: ./my-portfolio-backend
        run: |
          mvn org.owasp:dependency-check-maven:check || echo "OWASP扫描未配置"
        continue-on-error: true

      - name: 代码安全扫描
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: true

  # Docker镜像构建
  build-images:
    name: 构建Docker镜像
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, security-scan]
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到容器注册表
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 下载前端构建产物
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: my-portfolio/dist

      - name: 下载后端构建产物
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: my-portfolio-backend/target

      - name: 提取元数据（前端）
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: 提取元数据（后端）
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: 构建并推送前端镜像
        uses: docker/build-push-action@v5
        with:
          context: ./my-portfolio
          file: ./my-portfolio/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 构建并推送后端镜像
        uses: docker/build-push-action@v5
        with:
          context: ./my-portfolio-backend
          file: ./my-portfolio-backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 部署到开发环境
  deploy-dev:
    name: 部署到开发环境
    runs-on: ubuntu-latest
    needs: build-images
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: development
      url: ${{ secrets.DEV_ENV_URL }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 部署到开发环境
        run: |
          echo "部署到开发环境..."
          # 这里添加实际的部署命令，例如：
          # kubectl apply -f k8s/dev/
          # 或使用其他部署工具
        env:
          KUBECONFIG: ${{ secrets.DEV_KUBECONFIG }}
          DOCKER_REGISTRY: ${{ env.REGISTRY }}

  # 部署到预发布环境
  deploy-staging:
    name: 部署到预发布环境
    runs-on: ubuntu-latest
    needs: build-images
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: ${{ secrets.STAGING_ENV_URL }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 部署到预发布环境
        run: |
          echo "部署到预发布环境..."
          # 这里添加实际的部署命令
        env:
          KUBECONFIG: ${{ secrets.STAGING_KUBECONFIG }}
          DOCKER_REGISTRY: ${{ env.REGISTRY }}

      - name: 运行集成测试
        run: |
          echo "运行集成测试..."
          # 添加集成测试命令
        continue-on-error: true

  # 部署到生产环境
  deploy-production:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    needs: build-images
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: ${{ secrets.PROD_ENV_URL }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 生产环境部署确认
        run: |
          echo "准备部署到生产环境..."
          echo "请确认所有检查已通过"

      - name: 部署到生产环境
        run: |
          echo "部署到生产环境..."
          # 这里添加实际的部署命令
        env:
          KUBECONFIG: ${{ secrets.PROD_KUBECONFIG }}
          DOCKER_REGISTRY: ${{ env.REGISTRY }}

      - name: 健康检查
        run: |
          echo "执行生产环境健康检查..."
          # 添加健康检查脚本
        continue-on-error: false

      - name: 回滚准备
        if: failure()
        run: |
          echo "部署失败，准备回滚..."
          # 添加回滚脚本

  # 通知
  notify:
    name: 通知
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-staging, deploy-production]
    if: always()
    steps:
      - name: 发送通知
        run: |
          echo "发送部署通知..."
          # 可以集成企业微信、钉钉、Slack等通知
        continue-on-error: true

